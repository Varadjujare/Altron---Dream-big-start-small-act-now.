<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>Analytics - Altron</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/navbar.css">
    
    <!-- External Libraries for Advanced Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Heatmap Calendar Styles */
        .heatmap-wrapper { margin: 20px 0; }
        .heatmap-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
        .heatmap-legend { display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text-muted); }
        .heatmap-grid { display: grid; grid-template-columns: repeat(53, 12px); grid-template-rows: repeat(7, 12px); gap: 3px; overflow-x: auto; padding: 8px 0; }
        .heatmap-cell { width: 12px; height: 12px; border-radius: 2px; cursor: pointer; transition: all 0.2s; border: 1px solid var(--bg-secondary); }
        .heatmap-cell:hover { transform: scale(1.3); z-index: 10; border-color: var(--accent-primary); }
        .heatmap-cell.level-0 { background: var(--bg-tertiary); }
        .heatmap-cell.level-1 { background: #0e4429; }
        .heatmap-cell.level-2 { background: #006d32; }
        .heatmap-cell.level-3 { background: #26a641; }
        .heatmap-cell.level-4 { background: #39d353; }
        .heatmap-tooltip { position: absolute; background: var(--bg-primary); border: 1px solid var(--border-light); padding: 8px 12px; border-radius: 6px; font-size: 12px; pointer-events: none; z-index: 1000; display: none; box-shadow: var(--shadow-lg); }
        
        /* Chart Containers */
        .chart-canvas-wrapper { position: relative; height: 300px; margin: 20px 0; }
        .period-selector { display: flex; gap: 8px; margin-bottom: 16px; }
        .period-btn { padding: 6px 16px; border-radius: 6px; background: var(--bg-tertiary); border: 1px solid var(--border-light); cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .period-btn:hover { background: var(--bg-secondary); }
        .period-btn.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }
        
        /* Habit Strength Styles */
        .habit-strength-list { display: flex; flex-direction: column; gap: 16px; }
        .habit-strength-item { background: var(--bg-tertiary); padding: 16px; border-radius: 12px; border: 1px solid var(--border-light); }
        .habit-strength-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .habit-strength-name { margin: 0; font-size: 16px; font-weight: 600; }
        .habit-strength-metrics { display: flex; flex-direction: column; gap: 12px; }
        .metric { display: flex; flex-direction: column; gap: 6px; }
        .metric-label { font-size: 12px; color: var(--text-muted); }
        .metric-bar-wrapper { width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden; }
        .metric-bar { height: 100%; background: var(--gradient-primary); border-radius: 4px; transition: width 0.5s ease; }
        .metric-value { font-size: 14px; font-weight: 600; }
        .metric-stats { display: flex; gap: 24px; margin-top: 8px; }
        .metric-stat { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .metric-stat-icon { font-size: 20px; }
        .metric-stat-value { font-size: 18px; font-weight: 700; color: var(--accent-primary); }
        .metric-stat-label { font-size: 11px; color: var(--text-muted); }
        
        /* Correlation Styles */
        .correlation-list { display: flex; flex-direction: column; gap: 12px; }
        .correlation-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; }
        .correlation-habits { flex: 1; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .correlation-habit { font-weight: 500; }
        .correlation-arrow { color: var(--text-muted); }
        .correlation-bar-wrapper { flex: 1; max-width: 200px; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden; }
        .correlation-bar { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .correlation-bar.level-0 { background: #6e7681; }
        .correlation-bar.level-1 { background: #0e4429; }
        .correlation-bar.level-2 { background: #006d32; }
        .correlation-bar.level-3 { background: #26a641; }
        .correlation-bar.level-4 { background: #39d353; }
        .correlation-value { font-size: 13px; font-weight: 600; min-width: 45px; text-align: right; }
        
        /* Comparison Changes */
        .comparison-changes { display: flex; gap: 24px; margin-top: 16px; justify-content: center; flex-wrap: wrap; }
        .change-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 16px; background: var(--bg-tertiary); border-radius: 12px; min-width: 120px; }
        .change-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .change-value { font-size: 20px; font-weight: 700; }
        .change-item.positive .change-value { color: var(--success); }
        .change-item.negative .change-value { color: var(--error); }
        
        /* Export Buttons */
        .export-actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; }
        .export-btn { display: flex; align-items: center; gap: 8px; }
        
        /* Existing chart styles */
        .chart-container { height: 200px; display: flex; align-items: flex-end; gap: 8px; padding: 16px 0; }
        .chart-bar { flex: 1; background: var(--gradient-primary); border-radius: 8px 8px 0 0; transition: height 0.5s ease; min-width: 30px; position: relative; }
        .chart-bar:hover { opacity: 0.8; }
        .chart-bar::after { content: attr(data-value); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: 600; padding: 2px 4px; opacity: 0; transition: opacity 0.2s; }
        .chart-bar:hover::after { opacity: 1; }
        .chart-labels { display: flex; gap: 8px; justify-content: space-between; border-top: 1px solid var(--border-light); padding-top: 8px; }
        .chart-label { flex: 1; text-align: center; font-size: 12px; color: var(--text-muted); }
        .streak-card { text-align: center; padding: 32px; }
        .streak-value { font-size: 64px; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1; }
        .streak-label { font-size: 14px; color: var(--text-secondary); margin-top: 8px; }
        
        @media (max-width: 768px) { 
            .streak-value { font-size: 48px; } 
            .streak-card { padding: 20px; }
            .heatmap-grid { grid-template-columns: repeat(53, 10px); grid-template-rows: repeat(7, 10px); gap: 2px; }
            .heatmap-cell { width: 10px; height: 10px; }
            .chart-canvas-wrapper { height: 250px; }
            .comparison-changes { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-brand"><img src="favicon.png" alt="Logo" class="nav-brand-icon" style="padding: 0; background: transparent;"><span class="nav-brand-text">Altron</span></div>
        <div class="nav-menu">
            <a href="/home">ğŸ  Home</a>
            <a href="/dashboard">ğŸ“Š Dashboard</a>
            <a href="/habits">âœ… Habits</a>
            <a href="/tasks">ğŸ“ Tasks</a>
            <a href="/calendar">ğŸ“… Calendar</a>
            <a href="/analytics" class="active">ğŸ“ˆ Analytics</a>
            <a href="/settings">âš™ï¸ Settings</a>
        </div>
        <div class="nav-actions">
            <button class="theme-toggle" onclick="Theme.toggle()"><span class="icon-sun">â˜€ï¸</span><span class="icon-moon">ğŸŒ™</span></button>
            <div class="hamburger" onclick="toggleMobileMenu()"><span></span><span></span><span></span></div>
        </div>
    </nav>
    <div class="mobile-menu" id="mobileMenu">
        <a href="/home">ğŸ  Home</a>
        <a href="/dashboard">ğŸ“Š Dashboard</a>
        <a href="/habits">âœ… Habits</a>
        <a href="/tasks">ğŸ“ Tasks</a>
        <a href="/calendar">ğŸ“… Calendar</a>
        <a href="/analytics" class="active">ğŸ“ˆ Analytics</a>
        <a href="/settings">âš™ï¸ Settings</a>
        <a href="#" onclick="Auth.logout()" style="color: var(--error);">ğŸšª Logout</a>
    </div>

    <main class="main-wrapper">
        <header class="page-header-simple">
            <div>
                <h1 class="page-title">Advanced Analytics</h1>
                <p class="page-subtitle">Deep insights into your productivity patterns</p>
            </div>
            <div class="export-actions">
                <button class="btn btn-secondary export-btn" onclick="exportToCSV()" id="exportCSVBtn">
                    <span>ğŸ“¥</span> Export CSV
                </button>
                <button class="btn btn-secondary export-btn" onclick="exportToPDF()" id="exportPDFBtn">
                    <span>ğŸ“„</span> Export PDF
                </button>
            </div>
        </header>

        <div class="page-content page-enter">
            <!-- Summary Stats (Existing) -->
            <div class="bento-grid grid-cols-3 stagger-children">
                <div class="card streak-card card-3d">
                    <div class="stat-icon success" style="margin: 0 auto 16px;">ğŸ”¥</div>
                    <div class="streak-value" id="currentStreak">0</div>
                    <div class="streak-label">Current Streak</div>
                </div>
                <div class="card streak-card card-3d">
                    <div class="stat-icon info" style="margin: 0 auto 16px;">ğŸ†</div>
                    <div class="streak-value" id="bestStreak">0</div>
                    <div class="streak-label">Best Streak</div>
                </div>
                <div class="card streak-card card-3d">
                    <div class="stat-icon warning" style="margin: 0 auto 16px;">ğŸ“Š</div>
                    <div class="streak-value" id="monthlyAvg">0%</div>
                    <div class="streak-label">Monthly Average</div>
                </div>
            </div>

            <!-- GitHub-style Heatmap Calendar -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.2s;">
                <div class="card-header"><h3 class="card-title">ğŸ“… Activity Heatmap</h3></div>
                <div class="card-body">
                    <div id="heatmapContainer"></div>
                </div>
            </div>

            <!-- Productivity Score Trends -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.3s;">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“ˆ Productivity Score Trends</h3>
                    <div class="period-selector">
                        <button class="period-btn" data-period="week" onclick="changePeriod('week')">7 Days</button>
                        <button class="period-btn active" data-period="month" onclick="changePeriod('month')">30 Days</button>
                        <button class="period-btn" data-period="year" onclick="changePeriod('year')">1 Year</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-canvas-wrapper">
                        <canvas id="productivityChart"></canvas>
                    </div>
                    <p class="text-muted text-sm">Productivity score combines habit completion (60%) and task completion (40%)</p>
                </div>
            </div>

            <!-- Habit Strength -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.4s;">
                <div class="card-header"><h3 class="card-title">ğŸ’ª Habit Strength Analysis</h3></div>
                <div class="card-body" id="habitStrengthContainer">
                    <div class="empty-state"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Correlation Matrix -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.5s;">
                <div class="card-header"><h3 class="card-title">ğŸ”— Habit Correlations</h3></div>
                <div class="card-body">
                    <p class="text-secondary mb-md">Discover which habits you tend to complete together</p>
                    <div id="correlationContainer">
                        <div class="empty-state"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- Month-over-Month Comparison -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.6s;">
                <div class="card-header"><h3 class="card-title">ğŸ“Š Month-over-Month Comparison</h3></div>
                <div class="card-body">
                    <div class="chart-canvas-wrapper">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                    <div id="comparisonChanges"></div>
                </div>
            </div>

            <!-- Weekly Progress (Existing) -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.7s;">
                <div class="card-header"><h3 class="card-title">Weekly Progress</h3></div>
                <div class="card-body">
                    <div class="chart-container" id="weeklyChart"></div>
                    <div class="chart-labels" id="weeklyLabels"></div>
                </div>
            </div>

            <!-- Habit Streaks (Existing) -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.8s;">
                <div class="card-header"><h3 class="card-title">Habit Streaks</h3></div>
                <div class="card-body" id="habitStreaks"></div>
            </div>

            <!-- Reports Section (Existing) -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.9s;">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“§ Automated Reports</h3>
                </div>
                <div class="card-body">
                    <p class="text-secondary mb-md">
                        Your progress reports are generated and sent automatically. No manual action required.
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border-light);">
                            <div style="font-size: 32px; margin-bottom: 12px;">ğŸ“…</div>
                            <h4 style="margin-bottom: 8px;">Weekly Report</h4>
                            <p class="text-muted" style="font-size: 13px;">Every Sunday at 9:00 AM</p>
                            <div class="badge badge-success mt-sm" style="display: inline-block;">âœ… Active</div>
                        </div>
                        
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border-light);">
                            <div style="font-size: 32px; margin-bottom: 12px;">ğŸ—“ï¸</div>
                            <h4 style="margin-bottom: 8px;">Monthly Report</h4>
                            <p class="text-muted" style="font-size: 13px;">1st of every Month</p>
                            <div class="badge badge-success mt-sm" style="display: inline-block;">âœ… Active</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/api.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/analytics-viz.js"></script>
    <script>
        async function init() { 
            if (!await Auth.requireAuth()) return; 
            await Promise.all([
                loadBasicAnalytics(),
                initAdvancedAnalytics()
            ]);
        }
        
        async function loadBasicAnalytics() {
            const [weekly, monthly, streaks] = await Promise.all([ 
                API.get('/api/analytics/weekly'), 
                API.get('/api/analytics/monthly'), 
                API.get('/api/analytics/streaks') 
            ]);
            
            if (weekly.success) renderWeeklyChart(weekly);
            if (monthly.success) document.getElementById('monthlyAvg').textContent = monthly.monthly_percentage + '%';
            if (streaks.success) {
                document.getElementById('currentStreak').textContent = streaks.totals.total_current_streak;
                document.getElementById('bestStreak').textContent = streaks.totals.total_best_streak;
                renderStreaks(streaks.habits);
            }
        }
        
        function renderWeeklyChart(data) {
            const chart = document.getElementById('weeklyChart');
            const labels = document.getElementById('weeklyLabels');
            const maxVal = Math.max(...data.daily_stats.map(d => d.completed), 1);
            chart.innerHTML = data.daily_stats.map((d, i) => { 
                const height = (d.completed / maxVal) * 100; 
                return `<div class="chart-bar chart-animate" style="height: ${height}%; animation-delay: ${i * 0.1}s" data-value="${d.completed}"></div>`; 
            }).join('');
            labels.innerHTML = data.daily_stats.map(d => `<div class="chart-label">${d.day_name}</div>`).join('');
        }
        
        function renderStreaks(habits) {
            const container = document.getElementById('habitStreaks');
            if (!habits.length) { container.innerHTML = '<p class="text-muted">No habits tracked yet.</p>'; return; }
            container.innerHTML = habits.map(h => `<div class="flex items-center justify-between mb-md" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><span class="font-medium">${h.habit_name}</span><div class="flex gap-lg"><span class="text-muted">Current: <strong class="text-success">${h.current_streak}</strong></span><span class="text-muted">Best: <strong>${h.best_streak}</strong></span></div></div>`).join('');
        }
        
        init();
    </script>
</body>
</html>
