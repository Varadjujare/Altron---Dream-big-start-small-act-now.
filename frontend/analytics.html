<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>Analytics - Altron</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/navbar.css">
    
    <!-- External Libraries for Advanced Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Heatmap Calendar Styles - Enhanced Visibility */
        .heatmap-wrapper { 
            margin: 20px 0; 
            padding: 20px;
            background: rgba(38, 166, 65, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(38, 166, 65, 0.1);
        }
        .heatmap-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            flex-wrap: wrap; 
            gap: 16px; 
        }
        .heatmap-header h4 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .heatmap-legend { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 13px; 
            color: var(--text-secondary); 
            background: var(--bg-tertiary);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-light);
        }
        .heatmap-legend .heatmap-cell {
            margin: 0 2px;
        }
        .heatmap-grid { 
            display: grid; 
            grid-template-columns: repeat(53, 14px); 
            grid-template-rows: repeat(7, 14px); 
            gap: 4px; 
            overflow-x: auto; 
            padding: 16px 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }
        .heatmap-cell { 
            width: 14px; 
            height: 14px; 
            border-radius: 3px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .heatmap-cell:hover { 
            transform: scale(1.4); 
            z-index: 10; 
            border-color: var(--accent-primary);
            box-shadow: 0 0 8px rgba(38, 166, 65, 0.4);
        }
        .heatmap-cell.level-0 { background: #161b22; border-color: #30363d; }
        .heatmap-cell.level-1 { background: #0e4429; border-color: #0e4429; }
        .heatmap-cell.level-2 { background: #006d32; border-color: #006d32; }
        .heatmap-cell.level-3 { background: #26a641; border-color: #26a641; }
        .heatmap-cell.level-4 { background: #39d353; border-color: #39d353; box-shadow: 0 0 4px rgba(57, 211, 83, 0.3); }
        .heatmap-tooltip { 
            position: absolute; 
            background: var(--bg-primary); 
            border: 1px solid var(--accent-primary); 
            padding: 10px 14px; 
            border-radius: 8px; 
            font-size: 13px; 
            pointer-events: none; 
            z-index: 1000; 
            display: none; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* Chart Containers - Enhanced */
        .chart-canvas-wrapper { 
            position: relative; 
            height: 350px; 
            margin: 20px 0; 
            padding: 20px;
            background: rgba(38, 166, 65, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(38, 166, 65, 0.08);
        }
        .period-selector { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px;
            background: var(--bg-tertiary);
            padding: 6px;
            border-radius: 10px;
            border: 1px solid var(--border-light);
            width: fit-content;
        }
        .period-btn { 
            padding: 8px 20px; 
            border-radius: 8px; 
            background: transparent; 
            border: none;
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }
        .period-btn:hover { 
            background: var(--bg-secondary); 
            color: var(--text-primary);
        }
        .period-btn.active { 
            background: var(--accent-primary); 
            color: white; 
            box-shadow: 0 2px 8px rgba(38, 166, 65, 0.3);
        }
        
        /* Habit Strength Styles - Enhanced */
        .habit-strength-list { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
        }
        .habit-strength-item { 
            background: var(--bg-tertiary); 
            padding: 20px; 
            border-radius: 14px; 
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .habit-strength-item:hover {
            border-color: rgba(38, 166, 65, 0.3);
            box-shadow: 0 4px 16px rgba(38, 166, 65, 0.15);
            transform: translateY(-2px);
        }
        .habit-strength-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-light);
        }
        .habit-strength-name { 
            margin: 0; 
            font-size: 17px; 
            font-weight: 600;
            color: var(--text-primary);
        }
        .habit-strength-metrics { 
            display: flex; 
            flex-direction: column; 
            gap: 16px; 
        }
        .metric { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        .metric-label { 
            font-size: 13px; 
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .metric-bar-wrapper { 
            width: 100%; 
            height: 10px; 
            background: var(--bg-secondary); 
            border-radius: 5px; 
            overflow: hidden;
            border: 1px solid var(--border-light);
        }
        .metric-bar { 
            height: 100%; 
            background: var(--gradient-primary); 
            border-radius: 5px; 
            transition: width 0.6s ease;
            box-shadow: 0 0 10px rgba(38, 166, 65, 0.4);
        }
        .metric-value { 
            font-size: 15px; 
            font-weight: 700;
            color: var(--accent-primary);
        }
        .metric-stats { 
            display: flex; 
            gap: 32px; 
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        .metric-stat { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 6px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            flex: 1;
        }
        .metric-stat-icon { 
            font-size: 24px; 
        }
        .metric-stat-value { 
            font-size: 20px; 
            font-weight: 700; 
            color: var(--accent-primary);
        }
        .metric-stat-label { 
            font-size: 12px; 
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Correlation Styles - Enhanced */
        .correlation-list { 
            display: flex; 
            flex-direction: column; 
            gap: 14px; 
        }
        .correlation-item { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            padding: 16px; 
            background: var(--bg-tertiary); 
            border-radius: 10px;
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }
        .correlation-item:hover {
            background: rgba(38, 166, 65, 0.05);
            border-color: rgba(38, 166, 65, 0.2);
            transform: translateX(4px);
        }
        .correlation-habits { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 14px; 
        }
        .correlation-habit { 
            font-weight: 600;
            color: var(--text-primary);
        }
        .correlation-arrow { 
            color: var(--text-muted);
            font-size: 16px;
        }
        .correlation-bar-wrapper { 
            flex: 1; 
            max-width: 220px; 
            height: 10px; 
            background: var(--bg-secondary); 
            border-radius: 5px; 
            overflow: hidden;
            border: 1px solid var(--border-light);
        }
        .correlation-bar { 
            height: 100%; 
            border-radius: 5px; 
            transition: width 0.6s ease;
        }
        .correlation-bar.level-0 { background: #6e7681; }
        .correlation-bar.level-1 { background: #0e4429; box-shadow: 0 0 6px rgba(14, 68, 41, 0.4); }
        .correlation-bar.level-2 { background: #006d32; box-shadow: 0 0 6px rgba(0, 109, 50, 0.4); }
        .correlation-bar.level-3 { background: #26a641; box-shadow: 0 0 6px rgba(38, 166, 65, 0.4); }
        .correlation-bar.level-4 { background: #39d353; box-shadow: 0 0 8px rgba(57, 211, 83, 0.5); }
        .correlation-value { 
            font-size: 14px; 
            font-weight: 700; 
            min-width: 50px; 
            text-align: right;
            color: var(--accent-primary);
        }
        
        /* Comparison Changes - Enhanced */
        .comparison-changes { 
            display: flex; 
            gap: 28px; 
            margin-top: 20px; 
            justify-content: center; 
            flex-wrap: wrap; 
        }
        .change-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 8px; 
            padding: 20px 28px; 
            background: var(--bg-tertiary); 
            border-radius: 14px; 
            min-width: 140px;
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .change-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        .change-label { 
            font-size: 13px; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 0.8px;
            font-weight: 600;
        }
        .change-value { 
            font-size: 24px; 
            font-weight: 700; 
        }
        .change-item.positive .change-value { color: var(--success); }
        .change-item.negative .change-value { color: var(--error); }
        
        /* Export Buttons - Enhanced */
        .export-actions { 
            display: flex; 
            gap: 14px; 
            flex-wrap: wrap;
        }
        .export-btn { 
            display: flex; 
            align-items: center; 
            gap: 10px;
            font-weight: 500;
        }
        
        /* Existing chart styles */
        .chart-container { height: 200px; display: flex; align-items: flex-end; gap: 8px; padding: 16px 0; }
        .chart-bar { flex: 1; background: var(--gradient-primary); border-radius: 8px 8px 0 0; transition: height 0.5s ease; min-width: 30px; position: relative; }
        .chart-bar:hover { opacity: 0.8; }
        .chart-bar::after { content: attr(data-value); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: 600; padding: 2px 4px; opacity: 0; transition: opacity 0.2s; }
        .chart-bar:hover::after { opacity: 1; }
        .chart-labels { display: flex; gap: 8px; justify-content: space-between; border-top: 1px solid var(--border-light); padding-top: 8px; }
        .chart-label { flex: 1; text-align: center; font-size: 12px; color: var(--text-muted); }
        .streak-card { text-align: center; padding: 32px; }
        .streak-value { font-size: 64px; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1; }
        .streak-label { font-size: 14px; color: var(--text-secondary); margin-top: 8px; }
        
        @media (max-width: 768px) { 
            .streak-value { font-size: 48px; } 
            .streak-card { padding: 20px; }
            .heatmap-grid { grid-template-columns: repeat(53, 11px); grid-template-rows: repeat(7, 11px); gap: 3px; }
            .heatmap-cell { width: 11px; height: 11px; }
            .chart-canvas-wrapper { height: 280px; padding: 16px; }
            .comparison-changes { flex-direction: column; }
            .change-item { min-width: 100%; }
            .metric-stats { gap: 16px; }
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-brand"><img src="favicon.png" alt="Logo" class="nav-brand-icon" style="padding: 0; background: transparent;"><span class="nav-brand-text">Altron</span></div>
        <div class="nav-menu">
            <a href="/home">üè† Home</a>
            <a href="/dashboard">üìä Dashboard</a>
            <a href="/habits">‚úÖ Habits</a>
            <a href="/tasks">üìù Tasks</a>
            <a href="/calendar">üìÖ Calendar</a>
            <a href="/analytics" class="active">üìà Analytics</a>
            <a href="/settings">‚öôÔ∏è Settings</a>
        </div>
        <div class="nav-actions">
            <button class="theme-toggle" onclick="Theme.toggle()"><span class="icon-sun">‚òÄÔ∏è</span><span class="icon-moon">üåô</span></button>
            <div class="hamburger" onclick="toggleMobileMenu()"><span></span><span></span><span></span></div>
        </div>
    </nav>
    <div class="mobile-menu" id="mobileMenu">
        <a href="/home">üè† Home</a>
        <a href="/dashboard">üìä Dashboard</a>
        <a href="/habits">‚úÖ Habits</a>
        <a href="/tasks">üìù Tasks</a>
        <a href="/calendar">üìÖ Calendar</a>
        <a href="/analytics" class="active">üìà Analytics</a>
        <a href="/settings">‚öôÔ∏è Settings</a>
        <a href="#" onclick="Auth.logout()" style="color: var(--error);">üö™ Logout</a>
    </div>

    <main class="main-wrapper">
        <header class="page-header-simple">
            <div>
                <h1 class="page-title">Advanced Analytics</h1>
                <p class="page-subtitle">Deep insights into your productivity patterns</p>
            </div>
            <div class="export-actions">
                <button class="btn btn-secondary export-btn" onclick="exportToCSV()" id="exportCSVBtn">
                    <span>üì•</span> Export CSV
                </button>
                <button class="btn btn-secondary export-btn" onclick="exportToPDF()" id="exportPDFBtn">
                    <span>üìÑ</span> Export PDF
                </button>
            </div>
        </header>

        <div class="page-content page-enter">
            <!-- Summary Stats (Existing) -->
            <div class="bento-grid grid-cols-3 stagger-children">
                <div class="card streak-card card-3d">
                    <div class="stat-icon success" style="margin: 0 auto 16px;">üî•</div>
                    <div class="streak-value" id="currentStreak">0</div>
                    <div class="streak-label">Current Streak</div>
                </div>
                <div class="card streak-card card-3d">
                    <div class="stat-icon info" style="margin: 0 auto 16px;">üèÜ</div>
                    <div class="streak-value" id="bestStreak">0</div>
                    <div class="streak-label">Best Streak</div>
                </div>
                <div class="card streak-card card-3d">
                    <div class="stat-icon warning" style="margin: 0 auto 16px;">üìä</div>
                    <div class="streak-value" id="monthlyAvg">0%</div>
                    <div class="streak-label">Monthly Average</div>
                </div>
            </div>

            <!-- GitHub-style Heatmap Calendar -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.2s;">
                <div class="card-header"><h3 class="card-title">üìÖ Activity Heatmap</h3></div>
                <div class="card-body">
                    <div id="heatmapContainer"></div>
                </div>
            </div>

            <!-- Productivity Score Trends -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.3s;">
                <div class="card-header">
                    <h3 class="card-title">üìà Productivity Score Trends</h3>
                    <div class="period-selector">
                        <button class="period-btn" data-period="week" onclick="changePeriod('week')">7 Days</button>
                        <button class="period-btn active" data-period="month" onclick="changePeriod('month')">30 Days</button>
                        <button class="period-btn" data-period="year" onclick="changePeriod('year')">1 Year</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-canvas-wrapper">
                        <canvas id="productivityChart"></canvas>
                    </div>
                    <p class="text-muted text-sm">Productivity score combines habit completion (60%) and task completion (40%)</p>
                </div>
            </div>

            <!-- Habit Strength -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.4s;">
                <div class="card-header"><h3 class="card-title">üí™ Habit Strength Analysis</h3></div>
                <div class="card-body" id="habitStrengthContainer">
                    <div class="empty-state"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Correlation Matrix -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.5s;">
                <div class="card-header"><h3 class="card-title">üîó Habit Correlations</h3></div>
                <div class="card-body">
                    <p class="text-secondary mb-md">Discover which habits you tend to complete together</p>
                    <div id="correlationContainer">
                        <div class="empty-state"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- Month-over-Month Comparison -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.6s;">
                <div class="card-header"><h3 class="card-title">üìä Month-over-Month Comparison</h3></div>
                <div class="card-body">
                    <div class="chart-canvas-wrapper">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                    <div id="comparisonChanges"></div>
                </div>
            </div>

            <!-- Weekly Progress (Existing) -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.7s;">
                <div class="card-header"><h3 class="card-title">Weekly Progress</h3></div>
                <div class="card-body">
                    <div class="chart-container" id="weeklyChart"></div>
                    <div class="chart-labels" id="weeklyLabels"></div>
                </div>
            </div>

            <!-- Habit Streaks (Existing) -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.8s;">
                <div class="card-header"><h3 class="card-title">Habit Streaks</h3></div>
                <div class="card-body" id="habitStreaks"></div>
            </div>

            <!-- Reports Section (Existing) -->
            <div class="card mt-lg slide-in-up" style="animation-delay: 0.9s;">
                <div class="card-header">
                    <h3 class="card-title">üìß Automated Reports</h3>
                </div>
                <div class="card-body">
                    <p class="text-secondary mb-md">
                        Your progress reports are generated and sent automatically. No manual action required.
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border-light);">
                            <div style="font-size: 32px; margin-bottom: 12px;">üìÖ</div>
                            <h4 style="margin-bottom: 8px;">Weekly Report</h4>
                            <p class="text-muted" style="font-size: 13px;">Every Sunday at 9:00 AM</p>
                            <div class="badge badge-success mt-sm" style="display: inline-block;">‚úÖ Active</div>
                        </div>
                        
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border-light);">
                            <div style="font-size: 32px; margin-bottom: 12px;">üóìÔ∏è</div>
                            <h4 style="margin-bottom: 8px;">Monthly Report</h4>
                            <p class="text-muted" style="font-size: 13px;">1st of every Month</p>
                            <div class="badge badge-success mt-sm" style="display: inline-block;">‚úÖ Active</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/api.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/analytics-viz.js"></script>
    <script>
        async function init() { 
            if (!await Auth.requireAuth()) return; 
            await Promise.all([
                loadBasicAnalytics(),
                initAdvancedAnalytics()
            ]);
        }
        
        async function loadBasicAnalytics() {
            const [weekly, monthly, streaks] = await Promise.all([ 
                API.get('/api/analytics/weekly'), 
                API.get('/api/analytics/monthly'), 
                API.get('/api/analytics/streaks') 
            ]);
            
            if (weekly.success) renderWeeklyChart(weekly);
            if (monthly.success) document.getElementById('monthlyAvg').textContent = monthly.monthly_percentage + '%';
            if (streaks.success) {
                document.getElementById('currentStreak').textContent = streaks.totals.total_current_streak;
                document.getElementById('bestStreak').textContent = streaks.totals.total_best_streak;
                renderStreaks(streaks.habits);
            }
        }
        
        function renderWeeklyChart(data) {
            const chart = document.getElementById('weeklyChart');
            const labels = document.getElementById('weeklyLabels');
            const maxVal = Math.max(...data.daily_stats.map(d => d.completed), 1);
            chart.innerHTML = data.daily_stats.map((d, i) => { 
                const height = (d.completed / maxVal) * 100; 
                return `<div class="chart-bar chart-animate" style="height: ${height}%; animation-delay: ${i * 0.1}s" data-value="${d.completed}"></div>`; 
            }).join('');
            labels.innerHTML = data.daily_stats.map(d => `<div class="chart-label">${d.day_name}</div>`).join('');
        }
        
        function renderStreaks(habits) {
            const container = document.getElementById('habitStreaks');
            if (!habits.length) { container.innerHTML = '<p class="text-muted">No habits tracked yet.</p>'; return; }
            container.innerHTML = habits.map(h => `<div class="flex items-center justify-between mb-md" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><span class="font-medium">${h.habit_name}</span><div class="flex gap-lg"><span class="text-muted">Current: <strong class="text-success">${h.current_streak}</strong></span><span class="text-muted">Best: <strong>${h.best_streak}</strong></span></div></div>`).join('');
        }
        
        init();
    </script>
</body>
</html>
